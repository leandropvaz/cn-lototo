@page "/"
@rendermode InteractiveServer

@using CN.Lototo.Web.Dto
@using CN.Lototo.Web.Services
@using CN.Lototo.Application.Dto
@using CN.Lototo.Application.Services
@using Microsoft.AspNetCore.WebUtilities

@inject NavigationManager Nav
@inject AuthService AuthService
@inject PlantasService PlantaService

@layout EmptyLayout

<div class="container d-flex justify-content-center align-items-center min-vh-100">
    <div class="row w-100 justify-content-center">
        <div class="col-11 col-sm-7 col-md-5 col-lg-4">
            <div class="card shadow login-card">
                <div class="card-body p-3 p-sm-4">

                    <!-- Logo -->
                    <img src="/images/CN.png"
                         alt="Cimento Nacional"
                         class="mb-3 d-block mx-auto login-logo" />

                    <div class="login-title-wrapper text-center mb-3">
                        <i class="nav-icon fas fa-tools login-title-icon"></i>
                        <span class="login-title-text">Lototo</span>
@*                         <i class="nav-icon fas fa-tools login-title-icon"></i> *@
                    </div>

                    <!-- Formulário de Login -->
                    <EditForm Model="@vm" OnValidSubmit="LoginAsync">
                        <DataAnnotationsValidator />

                        <div class="mb-2 text-start">
                            <label class="form-label login-label">Login</label>
                            <InputText @bind-Value="vm.Login" class="form-control form-control-sm login-input" />
                        </div>

                        <div class="mb-2 text-start">
                            <label class="form-label login-label">Senha</label>
                            <InputText @bind-Value="vm.Senha" type="password" class="form-control form-control-sm login-input" />
                        </div>

                        <div class="mb-3 text-start">
                            <label class="form-label login-label">Planta</label>
                            <InputSelect @bind-Value="vm.PlantaId" class="form-control form-control-sm login-input">
                                <option value="">Selecione...</option>
                                @foreach (var planta in Plantas)
                                {
                                    <option value="@planta.Id">
                                        @planta.Nome (@planta.Codigo)
                                    </option>
                                }
                            </InputSelect>
                        </div>

                        <button class="btn btn-primary w-100 btn-sm btn-login">
                            Entrar
                        </button>

                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-warning mt-2 py-2 px-2 login-alert">
                                @errorMessage
                            </div>
                        }
                    </EditForm>

                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .login-title-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .login-title-text {
        font-weight: 500;
        font-size: 1rem;
        letter-spacing: 1px;
        color: #444;
    }

    .login-title-icon {
        font-size: 0.9rem;
        opacity: 0.7;
    }

    .login-card {
        background-color: #ede8e2;
        border-radius: 14px;
        font-size: 0.85rem;
    }

    .login-logo {
        max-width: 170px;
        height: auto;
    }

    .login-label {
        font-size: 0.78rem;
        margin-bottom: 0.1rem;
    }

    .login-input {
        font-size: 0.80rem;
        height: calc(1.4rem + 2px);
        padding: 0.2rem 0.4rem;
    }

    .btn-login {
        font-size: 0.85rem;
        padding-top: 0.35rem;
        padding-bottom: 0.35rem;
    }

    .login-alert {
        font-size: 0.78rem;
    }
</style>

@code {
    private LoginDto vm = new();
    private string errorMessage = string.Empty;

    private List<PlantasDto> Plantas { get; set; } = new();
    private string? _returnUrl;

    protected override async Task OnInitializedAsync()
    {
        vm = new LoginDto();

        // lê ReturnUrl se veio (?ReturnUrl=/home)
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);
        if (query.TryGetValue("ReturnUrl", out var values))
        {
            _returnUrl = values.FirstOrDefault();
        }

        var dtos = await PlantaService.ListarAsync();
        Plantas = dtos.OrderBy(p => p.Nome).ToList();
    }

    private async Task LoginAsync()
    {
        errorMessage = string.Empty;

        // planta passa a ser opcional aqui
        int? plantaId = vm.PlantaId;
        if (plantaId == 0)
            plantaId = null;

        var resultado = await AuthService.LoginAsync(vm.Login, vm.Senha, plantaId);

        if (!resultado.Success)
        {
            errorMessage = resultado.ErrorMessage ?? "Não foi possível autenticar. Verifique os dados e tente novamente.";
            return;
        }

        var destino = string.IsNullOrWhiteSpace(_returnUrl) ? "/home" : _returnUrl;
        Nav.NavigateTo(destino, forceLoad: true);
    }

}
