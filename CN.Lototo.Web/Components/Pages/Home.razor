@page "/home"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using CN.Lototo.Application.Dto
@using CN.Lototo.Application.Interfaces
@inject IEquipamentoAppService EquipamentoAppService
@inject PlantasService PlantaService
@inject IJSRuntime Js
@layout MainLayout

<section class="content pt-3">
    <div class="container-fluid">

        <!-- TÍTULO / CONTEXTO PLANTA -->
        <div class="row mb-2">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0 conteudo-titulo">
                        <i class="fas fa-bolt mr-1"></i>
                        Consulta de energias perigosas por equipamento
                    </h4>
                    <small class="text-muted titulo-planta">
                        Planta atual:
                        @if (!string.IsNullOrEmpty(PlantaDescricao))
                        {
                            <strong>@PlantaDescricao</strong>
                        }
                        else
                        {
                            <span class="text-danger">Planta não definida nas claims</span>
                        }
                    </small>
                </div>
            </div>
        </div>

        <div class="row">

            <!-- CARD FILTROS -->
            <div class="col-12">
                <div class="card card-primary card-outline mb-3">
                    <div class="card-header">
                        <h3 class="card-title card-title-compact">
                            <i class="fas fa-search mr-1"></i>
                            Filtros de pesquisa
                        </h3>
                    </div>
                    <div class="card-body filtros-body">
                        <EditForm OnValidSubmit="BuscarAsync" Model="@this">
                            <div class="form-row">
                                <div class="form-group col-12 col-md-3">
                                    <label class="filtro-label">Tag do equipamento</label>
                                    <InputText class="form-control form-control-sm filtro-input"
                                               @bind-Value="FiltroTag"
                                               placeholder="Ex.: FMTZ-100-BC11" />
                                </div>

                                <div class="form-group col-12 col-md-3">
                                    <label class="filtro-label">Nome / descrição do equipamento</label>
                                    <InputText class="form-control form-control-sm filtro-input"
                                               @bind-Value="FiltroNomeEquipamento"
                                               placeholder="Parte do nome..." />
                                </div>

                                <div class="form-group col-12 col-md-3">
                                    <label class="filtro-label">Tipo de energia</label>
                                    <InputText class="form-control form-control-sm filtro-input"
                                               @bind-Value="FiltroTipoEnergia"
                                               placeholder="Ex.: Elétrica, Pneumática..." />
                                </div>

                                <div class="form-group col-12 col-md-3">
                                    <label class="filtro-label">Descrição da energia perigosa</label>
                                    <InputText class="form-control form-control-sm filtro-input"
                                               @bind-Value="FiltroDescricaoEnergia"
                                               placeholder="Parte da descrição..." />
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group col-12 col-md-3">
                                    <label class="filtro-label">TAG disp. isolamento</label>
                                    <InputText class="form-control form-control-sm filtro-input"
                                               @bind-Value="FiltroTagDispositivo"
                                               placeholder="TAG dispositivo" />
                                </div>

                                <div class="form-group col-12 col-md-3">
                                    <label class="filtro-label">Localização dispositivo</label>
                                    <InputText class="form-control form-control-sm filtro-input"
                                               @bind-Value="FiltroLocalizacaoDispositivo"
                                               placeholder="Painel, área, sala..." />
                                </div>

                                <div class="form-group col-12 col-md-3">
                                    <label class="filtro-label">Dispositivo de isolamento</label>
                                    <InputText class="form-control form-control-sm filtro-input"
                                               @bind-Value="FiltroDispositivoIsolamento"
                                               placeholder="Disjuntor, válvula, etc." />
                                </div>

                                <div class="form-group col-12 col-md-3">
                                    <label class="filtro-label">Bloqueio</label>
                                    <InputText class="form-control form-control-sm filtro-input"
                                               @bind-Value="FiltroBloqueio"
                                               placeholder="Tipo de bloqueio" />
                                </div>
                            </div>

                            <div class="d-flex justify-content-end mt-1">
                                <button type="button"
                                        class="btn btn-default btn-sm btn-compact mr-2"
                                        @onclick="LimparFiltros">
                                    <i class="fas fa-eraser mr-1"></i> Limpar
                                </button>
                                <button type="submit"
                                        class="btn btn-primary btn-sm btn-compact"
                                        disabled="@CarregandoEquipamentos">
                                    <i class="fas fa-search mr-1"></i>
                                    @(CarregandoEquipamentos ? "A pesquisar..." : "Pesquisar")
                                </button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>

            <!-- CARD RESULTADOS -->
            <div class="col-12">
                <div class="card card-info card-outline">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="card-title card-title-compact">
                            <i class="fas fa-list mr-1"></i>
                            Resultados
                        </h3>

                        <div class="card-tools">
                            <small class="text-muted resultados-info">
                                @if (Resultados?.Any() == true)
                                {
                                    @($"{Resultados.Count} equipamento(s) encontrado(s)")
                                }
                                else if (!CarregandoEquipamentos && PlantIdAtual > 0)
                                {
                                    @("Nenhum equipamento encontrado para os filtros")
                                }
                            </small>
                        </div>
                    </div>

                    <div class="card-body p-2">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover table-sm mb-0 equip-table">
                                <thead>
                                    <tr class="thead-light">
                                        <th colspan="5" class="text-center">I. Identificação</th>
                                        <th colspan="4" class="text-center">II. Controlo energias</th>
                                        <th rowspan="2" style="width: 5%;" class="text-center align-middle">Img</th>
                                    </tr>
                                    <tr class="thead-light">
                                        <th style="width: 8%;">Tag</th>
                                        <th style="width: 22%;">Equip.</th>
                                        <th style="width: 6%;">Nº</th>
                                        <th style="width: 12%;">Tipo energ.</th>
                                        <th style="width: 18%;">Desc. energ.</th>

                                        <th style="width: 10%;">TAG disp.</th>
                                        <th style="width: 14%;">Loc. disp.</th>
                                        <th style="width: 10%;">Disp.</th>
                                        <th style="width: 8%;">Bloq.</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (CarregandoEquipamentos)
                                    {
                                        <tr>
                                            <td colspan="10" class="text-center text-muted py-3">
                                                <i class="fas fa-sync-alt fa-spin mr-2"></i>
                                                A carregar equipamentos da planta...
                                            </td>
                                        </tr>
                                    }
                                    else if (Resultados?.Any() == true)
                                    {
                                        @foreach (var e in Resultados)
                                        {
                                            <tr class="@(e.IsDeleted ? "table-danger" : "")">
                                                <td>@e.Tag</td>
                                                <td>@e.EquipmentName</td>
                                                <td>@e.LineNumber</td>
                                                <td>@e.EnergyType</td>
                                                <td>@e.HazardDescription</td>

                                                <td>@e.IsolationDeviceTag</td>
                                                <td>@e.IsolationDeviceLocation</td>
                                                <td>@e.IsolationDeviceDescription</td>
                                                <td>@e.LockoutType</td>

                                                <td class="text-center">
                                                    @if (!string.IsNullOrEmpty(e.ImageBlobUrl))
                                                    {
                                                        <button class="btn btn-xs btn-outline-secondary"
                                                                title="Ver imagem"
                                                                @onclick="() => AbrirModalImagem(e)">
                                                            <i class="fas fa-image"></i>
                                                        </button>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td colspan="10" class="text-center text-muted py-3">
                                                Nenhum registo para os filtros informados.
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>

        </div>

        @* MODAL IMAGEM SIMPLES *@
        @if (MostrarModalImagem)
        {
            <div class="modal fade show"
                 tabindex="-1"
                 role="dialog"
                 style="display:block;"
                 aria-modal="true">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-header bg-pw-blue">
                            <h5 class="modal-title">
                                <i class="fas fa-image mr-1"></i>
                                @ImagemModalTitulo
                            </h5>
                            <button type="button"
                                    class="close"
                                    aria-label="Close"
                                    @onclick="FecharModalImagem">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>

                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-7 text-center mb-3 mb-md-0">
                                    @if (!string.IsNullOrEmpty(ImagemModalUrl))
                                    {
                                        <img src="@ImagemModalUrl" class="img-fluid" />
                                    }
                                    else
                                    {
                                        <p class="text-muted">Imagem não disponível.</p>
                                    }
                                </div>
                                <div class="col-md-5">
                                    <h6 class="mb-2">
                                        <i class="fas fa-sticky-note mr-1"></i>
                                        Notas
                                    </h6>
                                    @if (!string.IsNullOrWhiteSpace(ImagemModalNotas))
                                    {
                                        <div class="border rounded p-4 bg-warning" style="min-height: 80px;">
                                            @ImagemModalNotas
                                        </div>
                                    }
                                    else
                                    {
                                        <p class="text-muted mb-0">
                                            Nenhuma nota encontrada para esta imagem.
                                        </p>
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button"
                                    class="btn btn-secondary btn-compact"
                                    @onclick="FecharModalImagem">
                                Fechar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-backdrop fade show"></div>
        }

    </div>
</section>

<style>
    /* Título principal mais compacto */
    .conteudo-titulo {
        font-size: 1.1rem !important;
        font-weight: 600;
    }

    .titulo-planta {
        font-size: 0.78rem !important;
    }

    /* Cabeçalho dos cards menor */
    .card-title-compact {
        font-size: 0.9rem !important;
    }

    .card-header {
        padding: 0.45rem 0.9rem !important;
    }

    .filtros-body {
        padding: 0.55rem 0.9rem !important;
    }

    /* Labels dos filtros */
    .filtro-label {
        font-size: 0.78rem !important;
        margin-bottom: 0.1rem !important;
    }

    /* Inputs dos filtros */
    .filtro-input,
    .form-control-sm {
        font-size: 0.78rem !important;
        height: calc(1.4rem + 2px) !important;
        padding: 0.18rem 0.4rem !important;
    }

    .form-group {
        margin-bottom: 0.35rem !important;
    }

    /* Botões compactos */
    .btn-compact {
        font-size: 0.78rem !important;
        padding: 0.25rem 0.55rem !important;
    }

    .resultados-info {
        font-size: 0.76rem !important;
    }

    /* Tabela */
    .equip-table th,
    .equip-table td {
        font-size: 0.72rem;
        padding: 0.22rem 0.35rem;
    }

    .equip-table thead th {
        font-size: 0.7rem;
        white-space: nowrap;
    }
</style>

@code {
    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    private int PlantIdAtual { get; set; }
    private string? PlantaDescricao { get; set; }

    // Filtros
    private string? FiltroTag { get; set; }
    private string? FiltroNomeEquipamento { get; set; }
    private string? FiltroTipoEnergia { get; set; }
    private string? FiltroDescricaoEnergia { get; set; }
    private string? FiltroTagDispositivo { get; set; }
    private string? FiltroLocalizacaoDispositivo { get; set; }
    private string? FiltroDispositivoIsolamento { get; set; }
    private string? FiltroBloqueio { get; set; }

    // Dados
    private List<EquipamentoDto> TodosEquipamentos { get; set; } = new();
    private List<EquipamentoDto> Resultados { get; set; } = new();
    private bool CarregandoEquipamentos { get; set; }

    // Modal imagem
    private bool MostrarModalImagem;
    private string? ImagemModalUrl;
    private string? ImagemModalTitulo;
    private string? ImagemModalNotas;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateTask;
        var user = authState.User;

        if (user.Identity?.IsAuthenticated != true)
        {
            await Js.InvokeVoidAsync("adminlteToasts.show", "error", "Erro", "Utilizador não autenticado.");
            return;
        }

        // Tenta obter o plantId das claims
        var plantClaim = user.Claims.FirstOrDefault(c =>
            c.Type == "plantId" ||
            c.Type == "PlantaId" ||
            c.Type == "Plant");

        if (plantClaim == null || !int.TryParse(plantClaim.Value, out var plantId) || plantId <= 0)
        {
            await Js.InvokeVoidAsync("adminlteToasts.show", "error", "Erro", "Planta não encontrada nas claims do utilizador.");
            return;
        }

        PlantIdAtual = plantId;

        // Carrega nome/código da planta (opcional, só pra exibir bonito)
        try
        {
            var plantas = (await PlantaService.ListarAsync()).ToList();
            var planta = plantas.FirstOrDefault(p => p.Id == PlantIdAtual);
            if (planta != null)
            {
                PlantaDescricao = $"{planta.Nome} ({planta.Codigo})";
            }
        }
        catch
        {
            // Se der erro aqui, não bloqueia a página, só não mostra nome
        }

        await CarregarEquipamentosAsync();
        AplicarFiltros();
    }

    private async Task CarregarEquipamentosAsync()
    {
        if (PlantIdAtual <= 0)
            return;

        CarregandoEquipamentos = true;
        try
        {
            TodosEquipamentos = (await EquipamentoAppService.GetByPlantAsync(PlantIdAtual))
                .Where(e => !e.IsDeleted)
                .ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            await Js.InvokeVoidAsync("adminlteToasts.show", "error", "Erro", "Erro ao carregar equipamentos da planta.");
        }
        finally
        {
            CarregandoEquipamentos = false;
        }
    }

    private Task BuscarAsync()
    {
        AplicarFiltros();
        return Task.CompletedTask;
    }

    private void AplicarFiltros()
    {
        var query = TodosEquipamentos.AsQueryable();

        if (!string.IsNullOrWhiteSpace(FiltroTag))
        {
            query = query.Where(e =>
                (e.Tag ?? "").Contains(FiltroTag, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(FiltroNomeEquipamento))
        {
            query = query.Where(e =>
                (e.EquipmentName ?? "").Contains(FiltroNomeEquipamento, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(FiltroTipoEnergia))
        {
            query = query.Where(e =>
                (e.EnergyType ?? "").Contains(FiltroTipoEnergia, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(FiltroDescricaoEnergia))
        {
            query = query.Where(e =>
                (e.HazardDescription ?? "").Contains(FiltroDescricaoEnergia, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(FiltroTagDispositivo))
        {
            query = query.Where(e =>
                (e.IsolationDeviceTag ?? "").Contains(FiltroTagDispositivo, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(FiltroLocalizacaoDispositivo))
        {
            query = query.Where(e =>
                (e.IsolationDeviceLocation ?? "").Contains(FiltroLocalizacaoDispositivo, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(FiltroDispositivoIsolamento))
        {
            query = query.Where(e =>
                (e.IsolationDeviceDescription ?? "").Contains(FiltroDispositivoIsolamento, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(FiltroBloqueio))
        {
            query = query.Where(e =>
                (e.LockoutType ?? "").Contains(FiltroBloqueio, StringComparison.OrdinalIgnoreCase));
        }

        Resultados = query.ToList();
    }

    private void LimparFiltros()
    {
        FiltroTag = null;
        FiltroNomeEquipamento = null;
        FiltroTipoEnergia = null;
        FiltroDescricaoEnergia = null;
        FiltroTagDispositivo = null;
        FiltroLocalizacaoDispositivo = null;
        FiltroDispositivoIsolamento = null;
        FiltroBloqueio = null;

        AplicarFiltros();
    }

    private void AbrirModalImagem(EquipamentoDto eq)
    {
        ImagemModalUrl = eq.ImageBlobUrl;
        ImagemModalTitulo = $"{eq.Tag} - {eq.EquipmentName}";
        ImagemModalNotas = eq.ImageNotes;
        MostrarModalImagem = true;
    }

    private void FecharModalImagem()
    {
        MostrarModalImagem = false;
        ImagemModalUrl = null;
        ImagemModalTitulo = null;
        ImagemModalNotas = null;
    }
}
