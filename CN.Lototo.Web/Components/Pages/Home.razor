@page "/home"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using CN.Lototo.Application.Dto
@using CN.Lototo.Application.Interfaces
@inject IEquipamentoAppService EquipamentoAppService
@inject PlantasService PlantaService
@inject IJSRuntime Js
@layout MainLayout
@inject NavigationManager Nav


<section class="content pt-3">
    <div class="container-fluid">

        <!-- TÍTULO / CONTEXTO PLANTA -->
        <div class="row mb-2">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0 conteudo-titulo">
                        <i class="fas fa-bolt mr-1"></i>
                        Consulta de energias perigosas por equipamento
                    </h4>
                    @* Se quiser voltar a mostrar planta atual para não-supergestor, podes descomentar
                    <small class="text-muted titulo-planta">
                        Planta atual:
                        @if (!string.IsNullOrEmpty(PlantaDescricao))
                        {
                            <strong>@PlantaDescricao</strong>
                        }
                        else
                        {
                            <span class="text-danger">Planta não definida</span>
                        }
                    </small>
                    *@
                </div>
            </div>
        </div>

        <div class="row">

            <!-- CARD FILTROS -->
            <div class="col-12">
                <div class="card card-primary card-outline mb-3">
                    <div class="card-header">
                        <h3 class="card-title card-title-compact">
                            <i class="fas fa-search mr-1"></i>
                            Filtros de pesquisa
                        </h3>
                    </div>
                    <div class="card-body filtros-body">
                        <EditForm OnValidSubmit="BuscarAsync" Model="@this">

                            @* 🔹 LINHA EXTRA PARA SUPER GESTOR: SELEÇÃO DE PLANTA *@
                            @if (IsSuperGestor)
                            {
                                <div class="form-row mb-1">
                                    <div class="form-group col-12 col-md-4">
                                        <label class="filtro-label">Planta</label>
                                        <InputSelect class="form-control form-control-sm filtro-input"
                                                     @bind-Value="PlantaPesquisaId">
                                            <option value="">Selecione...</option>
                                            @foreach (var planta in Plantas)
                                            {
                                                <option value="@planta.Id">@planta.Nome (@planta.Codigo)</option>
                                            }
                                        </InputSelect>
                                    </div>
                                </div>
                            }

                            <div class="form-row">
                                <div class="form-group col-12 col-md-3">
                                    <label class="filtro-label">Tag do equipamento</label>
                                    <InputText class="form-control form-control-sm filtro-input"
                                               @bind-Value="FiltroTag"
                                               placeholder="Ex.: FMTZ-100-BC11" />
                                </div>

                                <div class="form-group col-12 col-md-3">
                                    <label class="filtro-label">Nome / descrição do equipamento</label>
                                    <InputText class="form-control form-control-sm filtro-input"
                                               @bind-Value="FiltroNomeEquipamento"
                                               placeholder="Parte do nome..." />
                                </div>

                                <div class="form-group col-12 col-md-3">
                                    <label class="filtro-label">Tipo de energia</label>
                                    <InputText class="form-control form-control-sm filtro-input"
                                               @bind-Value="FiltroTipoEnergia"
                                               placeholder="Ex.: Elétrica, Pneumática..." />
                                </div>

                                <div class="form-group col-12 col-md-3">
                                    <label class="filtro-label">Descrição da energia perigosa</label>
                                    <InputText class="form-control form-control-sm filtro-input"
                                               @bind-Value="FiltroDescricaoEnergia"
                                               placeholder="Parte da descrição..." />
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group col-12 col-md-3">
                                    <label class="filtro-label">TAG disp. isolamento</label>
                                    <InputText class="form-control form-control-sm filtro-input"
                                               @bind-Value="FiltroTagDispositivo"
                                               placeholder="TAG dispositivo" />
                                </div>

                                <div class="form-group col-12 col-md-3">
                                    <label class="filtro-label">Localização dispositivo</label>
                                    <InputText class="form-control form-control-sm filtro-input"
                                               @bind-Value="FiltroLocalizacaoDispositivo"
                                               placeholder="Painel, área, sala..." />
                                </div>

                                <div class="form-group col-12 col-md-3">
                                    <label class="filtro-label">Dispositivo de isolamento</label>
                                    <InputText class="form-control form-control-sm filtro-input"
                                               @bind-Value="FiltroDispositivoIsolamento"
                                               placeholder="Disjuntor, válvula, etc." />
                                </div>

                                <div class="form-group col-12 col-md-3">
                                    <label class="filtro-label">Bloqueio</label>
                                    <InputText class="form-control form-control-sm filtro-input"
                                               @bind-Value="FiltroBloqueio"
                                               placeholder="Tipo de bloqueio" />
                                </div>
                            </div>

                            <div class="d-flex justify-content-end mt-1">
                                <button type="button"
                                        class="btn btn-default btn-sm btn-compact mr-2"
                                        @onclick="LimparFiltros">
                                    <i class="fas fa-eraser mr-1"></i> Limpar
                                </button>
                                <button type="submit"
                                        class="btn btn-primary btn-sm btn-compact"
                                        disabled="@CarregandoEquipamentos">
                                    <i class="fas fa-search mr-1"></i>
                                    @(CarregandoEquipamentos ? "A pesquisar..." : "Pesquisar")
                                </button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>

            <!-- CARD RESULTADOS -->
            <div class="col-12">
                <div class="card card-info card-outline">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="card-title card-title-compact">
                            <i class="fas fa-list mr-1"></i>
                            Resultados
                        </h3>

                        <div class="card-tools">
                            <small class="text-muted resultados-info">
                                @if (Resultados?.Any() == true)
                                {
                                    @($"{Resultados.Count} equipamento(s) encontrado(s)")
                                }
                                else if (!CarregandoEquipamentos && PlantaPesquisaId.HasValue && PlantaPesquisaId > 0)
                                {
                                    @("Nenhum equipamento encontrado para os filtros")
                                }
                            </small>
                        </div>
                    </div>

                    <div class="card-body p-2">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover table-sm mb-0 equip-table">
                                <thead>
                                    <tr class="thead-light">
                                        <th colspan="5" class="text-center">I. Identificação</th>
                                        <th colspan="4" class="text-center">II. Controlo energias</th>
                                        <th rowspan="2" style="width: 5%;" class="text-center align-middle">Img</th>
                                    </tr>
                                    <tr class="thead-light">
                                        <th style="width: 8%;">Tag</th>
                                        <th style="width: 22%;">Equip.</th>
                                        <th style="width: 6%;">Nº</th>
                                        <th style="width: 12%;">Tipo energ.</th>
                                        <th style="width: 18%;">Desc. energ.</th>

                                        <th style="width: 10%;">TAG disp.</th>
                                        <th style="width: 14%;">Loc. disp.</th>
                                        <th style="width: 10%;">Disp.</th>
                                        <th style="width: 8%;">Bloq.</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (CarregandoEquipamentos)
                                    {
                                        <tr>
                                            <td colspan="10" class="text-center text-muted py-3">
                                                <i class="fas fa-sync-alt fa-spin mr-2"></i>
                                                A carregar equipamentos da planta...
                                            </td>
                                        </tr>
                                    }
                                    else if (Resultados?.Any() == true)
                                    {
                                        @foreach (var e in Resultados)
                                        {
                                            <tr class="@(e.IsDeleted ? "table-danger" : "")">
                                                <td>@e.Tag</td>
                                                <td>@e.EquipmentName</td>
                                                <td>@e.LineNumber</td>
                                                <td>@e.EnergyType</td>
                                                <td>@e.HazardDescription</td>

                                                <td>@e.IsolationDeviceTag</td>
                                                <td>@e.IsolationDeviceLocation</td>
                                                <td>@e.IsolationDeviceDescription</td>
                                                <td>@e.LockoutType</td>

                                                <td class="text-center">
                                                    @if (!string.IsNullOrEmpty(e.ImageBlobUrl))
                                                    {
                                                        <button class="btn btn-xs btn-outline-secondary"
                                                                title="Ver imagem"
                                                                @onclick="() => AbrirModalImagem(e)">
                                                            <i class="fas fa-image"></i>
                                                        </button>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td colspan="10" class="text-center text-muted py-3">
                                                Nenhum registo para os filtros informados.
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>

        </div>

        @* MODAL IMAGEM *@
        @if (MostrarModalImagem)
        {
            <div class="modal fade show"
                 tabindex="-1"
                 role="dialog"
                 style="display:block;"
                 aria-modal="true">
                <div class="modal-dialog modal-lg modal-dialog-centered modal-image" role="document">
                    <div class="modal-content">
                        <div class="modal-header bg-pw-blue text-white py-2">
                            <h5 class="modal-title mb-0">
                                <i class="fas fa-image mr-1"></i>
                                @ImagemModalTitulo
                            </h5>
                            <button type="button"
                                    class="close text-white"
                                    aria-label="Close"
                                    @onclick="FecharModalImagem">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>

                        <div class="modal-body">
                            <div class="d-flex flex-column flex-md-row align-items-start modal-image-content">
                                <div class="modal-image-wrapper text-center mb-3 mb-md-0 flex-fill">
                                    @if (!string.IsNullOrEmpty(ImagemModalUrl))
                                    {
                                        <img src="@ImagemModalUrl" class="img-fluid rounded shadow-sm" />
                                    }
                                    else
                                    {
                                        <p class="text-muted">Imagem não disponível.</p>
                                    }
                                </div>
                                <div class="modal-notes-wrapper ml-md-3">
                                    <h6 class="mb-2 text-muted">
                                        <i class="fas fa-sticky-note mr-1"></i>
                                        Notas
                                    </h6>
                                    @if (!string.IsNullOrWhiteSpace(ImagemModalNotas))
                                    {
                                        <div class="image-notes-bubble">
                                            @ImagemModalNotas
                                        </div>
                                    }
                                    else
                                    {
                                        <p class="text-muted mb-0">
                                            Nenhuma nota encontrada para esta imagem.
                                        </p>
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="modal-footer py-2">
                            <button type="button"
                                    class="btn btn-secondary btn-sm"
                                    @onclick="FecharModalImagem">
                                Fechar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-backdrop fade show"></div>
        }

    </div>
</section>

<style>
    .image-notes-bubble {
        background-color: #fff3cd;
        border: 1px solid #f1c453;
        border-radius: 0.75rem;
        padding: 0.65rem 0.9rem;
        font-size: 0.8rem;
        line-height: 1.3rem;
        position: relative;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

        .image-notes-bubble::before {
            content: "";
            position: absolute;
            left: -10px;
            top: 18px;
            border-width: 8px 10px 8px 0;
            border-style: solid;
            border-color: transparent #f1c453 transparent transparent;
        }

    .conteudo-titulo {
        font-size: 1.1rem !important;
        font-weight: 600;
    }

    .titulo-planta {
        font-size: 0.78rem !important;
    }

    .card-title-compact {
        font-size: 0.9rem !important;
    }

    .card-header {
        padding: 0.45rem 0.9rem !important;
    }

    .filtros-body {
        padding: 0.55rem 0.9rem !important;
    }

    .filtro-label {
        font-size: 0.78rem !important;
        margin-bottom: 0.1rem !important;
    }

    .filtro-input,
    .form-control-sm {
        font-size: 0.78rem !important;
        height: calc(1.4rem + 2px) !important;
        padding: 0.18rem 0.4rem !important;
    }

    .form-group {
        margin-bottom: 0.35rem !important;
    }

    .btn-compact {
        font-size: 0.78rem !important;
        padding: 0.25rem 0.55rem !important;
    }

    .resultados-info {
        font-size: 0.76rem !important;
    }

    .equip-table th,
    .equip-table td {
        font-size: 0.72rem;
        padding: 0.22rem 0.35rem;
    }

    .equip-table thead th {
        font-size: 0.7rem;
        white-space: nowrap;
    }
</style>


@code {
    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    private bool IsSuperGestor { get; set; }

    private int PlantIdAtual { get; set; }
    private string? PlantaDescricao { get; set; }

    // Planta usada para pesquisa (para não-super vem da claim; para SuperGestor vem do combo)
    private int? PlantaPesquisaId { get; set; }

    // Filtros
    private string? FiltroTag { get; set; }
    private string? FiltroNomeEquipamento { get; set; }
    private string? FiltroTipoEnergia { get; set; }
    private string? FiltroDescricaoEnergia { get; set; }
    private string? FiltroTagDispositivo { get; set; }
    private string? FiltroLocalizacaoDispositivo { get; set; }
    private string? FiltroDispositivoIsolamento { get; set; }
    private string? FiltroBloqueio { get; set; }

    // Dados
    private List<EquipamentoDto> TodosEquipamentos { get; set; } = new();
    private List<EquipamentoDto> Resultados { get; set; } = new();
    private bool CarregandoEquipamentos { get; set; }

    // Plantas (usada para SuperGestor)
    private List<PlantasDto> Plantas { get; set; } = new();

    // Modal imagem
    private bool MostrarModalImagem;
    private string? ImagemModalUrl;
    private string? ImagemModalTitulo;
    private string? ImagemModalNotas;

    // Flags para toasts
    private bool _mostrarToastNaoAutenticado;
    private bool _mostrarToastSemPlanta;
    private bool _mostrarToastErroCarregar;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateTask;
        var user = authState.User;

        if (user.Identity?.IsAuthenticated != true)
        {
            _mostrarToastNaoAutenticado = true;
            return;
        }

        IsSuperGestor = user.IsInRole("SuperGestor");

        if (IsSuperGestor)
        {
            // Super Gestor: carrega todas as plantas para o combo, mas não obriga claim de planta
            Plantas = (await PlantaService.ListarAsync())
                .OrderBy(p => p.Nome)
                .ToList();

            PlantaPesquisaId = null; // espera o utilizador escolher

            // Não carrega equipamentos ainda
            return;
        }

        // ---- Utilizadores que NÃO são SuperGestor ----
        var plantClaim = user.Claims.FirstOrDefault(c =>
            c.Type == "plantaId" ||
            c.Type == "PlantaId" ||
            c.Type == "Plant");

        if (plantClaim == null || !int.TryParse(plantClaim.Value, out var plantId) || plantId <= 0)
        {
            _mostrarToastSemPlanta = true;
            return;
        }

        PlantIdAtual = plantId;
        PlantaPesquisaId = plantId;

        try
        {
            var plantas = (await PlantaService.ListarAsync()).ToList();
            var planta = plantas.FirstOrDefault(p => p.Id == PlantIdAtual);
            if (planta != null)
            {
                PlantaDescricao = $"{planta.Nome} ({planta.Codigo})";
            }
        }
        catch
        {
            // erro a carregar planta não bloqueia a página
        }

        await CarregarEquipamentosAsync();
        AplicarFiltros();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return;

        if (_mostrarToastNaoAutenticado)
        {
            Nav.NavigateTo("/restricted", forceLoad: true);
        }
        else if (_mostrarToastSemPlanta && !IsSuperGestor)
        {
            await Js.InvokeVoidAsync("adminlteToasts.show", "error", "Erro", "Planta não encontrada nas claims do utilizador.");
        }
        else if (_mostrarToastErroCarregar)
        {
            await Js.InvokeVoidAsync("adminlteToasts.show", "error", "Erro", "Erro ao carregar equipamentos da planta.");
        }
    }

    private async Task CarregarEquipamentosAsync()
    {
        if (!PlantaPesquisaId.HasValue || PlantaPesquisaId <= 0)
        {
            TodosEquipamentos = new();
            Resultados = new();
            return;
        }

        CarregandoEquipamentos = true;
        try
        {
            TodosEquipamentos = (await EquipamentoAppService.GetByPlantAsync(PlantaPesquisaId.Value))
                .Where(e => !e.IsDeleted)
                .ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            _mostrarToastErroCarregar = true;
        }
        finally
        {
            CarregandoEquipamentos = false;
        }
    }

    private async Task BuscarAsync()
    {
        // Se for SuperGestor, obriga escolher a planta antes de pesquisar
        if (IsSuperGestor)
        {
            if (!PlantaPesquisaId.HasValue || PlantaPesquisaId <= 0)
            {
                await Js.InvokeVoidAsync("adminlteToasts.show",
                    "warning",
                    "Atenção",
                    "Selecione a planta para pesquisar os equipamentos.");
                return;
            }

            await CarregarEquipamentosAsync();
        }

        AplicarFiltros();
    }

    private void AplicarFiltros()
    {
        var query = TodosEquipamentos.AsQueryable();

        if (!string.IsNullOrWhiteSpace(FiltroTag))
        {
            query = query.Where(e =>
                (e.Tag ?? "").Contains(FiltroTag, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(FiltroNomeEquipamento))
        {
            query = query.Where(e =>
                (e.EquipmentName ?? "").Contains(FiltroNomeEquipamento, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(FiltroTipoEnergia))
        {
            query = query.Where(e =>
                (e.EnergyType ?? "").Contains(FiltroTipoEnergia, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(FiltroDescricaoEnergia))
        {
            query = query.Where(e =>
                (e.HazardDescription ?? "").Contains(FiltroDescricaoEnergia, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(FiltroTagDispositivo))
        {
            query = query.Where(e =>
                (e.IsolationDeviceTag ?? "").Contains(FiltroTagDispositivo, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(FiltroLocalizacaoDispositivo))
        {
            query = query.Where(e =>
                (e.IsolationDeviceLocation ?? "").Contains(FiltroLocalizacaoDispositivo, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(FiltroDispositivoIsolamento))
        {
            query = query.Where(e =>
                (e.IsolationDeviceDescription ?? "").Contains(FiltroDispositivoIsolamento, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(FiltroBloqueio))
        {
            query = query.Where(e =>
                (e.LockoutType ?? "").Contains(FiltroBloqueio, StringComparison.OrdinalIgnoreCase));
        }

        Resultados = query.ToList();
    }

    private void LimparFiltros()
    {
        FiltroTag = null;
        FiltroNomeEquipamento = null;
        FiltroTipoEnergia = null;
        FiltroDescricaoEnergia = null;
        FiltroTagDispositivo = null;
        FiltroLocalizacaoDispositivo = null;
        FiltroDispositivoIsolamento = null;
        FiltroBloqueio = null;

        AplicarFiltros();
    }

    private void AbrirModalImagem(EquipamentoDto eq)
    {
        ImagemModalUrl = eq.ImageBlobUrl;
        ImagemModalTitulo = $"{eq.Tag} - {eq.EquipmentName}";
        ImagemModalNotas = eq.ImageNotes;
        MostrarModalImagem = true;
    }

    private void FecharModalImagem()
    {
        MostrarModalImagem = false;
        ImagemModalUrl = null;
        ImagemModalTitulo = null;
        ImagemModalNotas = null;
    }
}
