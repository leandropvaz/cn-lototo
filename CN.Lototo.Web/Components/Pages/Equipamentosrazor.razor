@page "/equipamentos"
@using System.ComponentModel.DataAnnotations
@using System.Drawing
@using System.Drawing.Imaging
@using System.Linq
@using CN.Lototo.Application.Dto
@using CN.Lototo.Application.Interfaces
@using Microsoft.AspNetCore.Components.Authorization
@inject PlantasService PlantaService
@inject IEquipamentoAppService EquipamentoAppService
@inject IJSRuntime Js
@inject NavigationManager Nav

@layout MainLayout

<section class="content pt-3">
    <div class="container-fluid">

        <!-- LINHA 1 – WIZARD (100% LARGURA) -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card card-primary card-outline">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-cogs mr-1"></i>
                            @(IsEditMode ? "Editar Equipamento" : "Cadastro / Importação")
                        </h3>

                        <div class="card-tools">
                            <span class="badge badge-info badge-sm">Passo @passoAtual de 3</span>
                        </div>
                    </div>

                    <div class="card-body">

                        @* PASSO 1 *@
                        @if (passoAtual == 1)
                        {
                            <div class="form-group">
                                <label>Planta</label>
                                <select class="form-control"
                                        @onchange="PlantaAlterada"
                                        disabled="@(Importando || (PerfilLogado == PerfilUsuario.Administrador && PlantaIdLogado.HasValue))">
                                    <option value="">-- selecione a planta --</option>
                                    @foreach (var p in Plantas)
                                    {
                                        <option value="@p.Id" selected="@(PlantaSelecionadaId == p.Id)">
                                            @p.Nome (@p.Codigo)
                                        </option>
                                    }
                                </select>

                                @if (PerfilLogado == PerfilUsuario.Administrador && PlantaIdLogado.HasValue)
                                {
                                    <small class="form-text text-muted">
                                        A planta é fixa para o administrador.
                                    </small>
                                }
                            </div>

                            <div class="form-group mt-3">
                                <label>Modo de operação</label>

                                <div class="icheck-primary radio-small">
                                    <input type="radio" id="modoManual" name="modoCadastro"
                                           disabled="@Importando"
                                           checked="@(ModoSelecionado == ModoCadastro.Manual)"
                                           @onchange="() => ModoSelecionado = ModoCadastro.Manual" />
                                    <label for="modoManual">
                                        Cadastro manual @(IsEditMode ? "(edição)" : "")
                                    </label>
                                </div>

                                <div class="icheck-primary radio-small">
                                    <input type="radio" id="modoImportacao" name="modoCadastro"
                                           disabled="@Importando"
                                           checked="@(ModoSelecionado == ModoCadastro.ImportacaoExcel)"
                                           @onchange="() => ModoSelecionado = ModoCadastro.ImportacaoExcel" />
                                    <label for="modoImportacao">
                                        Importação via Excel (modelo LOTOTO)
                                    </label>
                                </div>
                            </div>

                        }
                        else if (passoAtual == 2)
                        {
                            @* PASSO 2 – MANUAL ou IMPORTAÇÃO *@

                            @if (ModoSelecionado == ModoCadastro.Manual)
                            {
                                <EditForm Model="@Manual" OnValidSubmit="SalvarManual">
                                    <DataAnnotationsValidator />
                                    <ValidationSummary class="text-danger mb-2" />

                                    @* CABEÇALHO *@
                                    <div class="card card-outline card-secondary mb-2">
                                        <div class="card-header py-2">
                                            <h6 class="card-title mb-0">
                                                <i class="fas fa-id-badge mr-1"></i>
                                                Cabeçalho do equipamento
                                            </h6>
                                        </div>
                                        <div class="card-body py-2">
                                            <div class="form-group">
                                                <label>Tag do equipamento</label>
                                                <InputText class="form-control" @bind-Value="Manual.Tag" />
                                                <ValidationMessage For="@(() => Manual.Tag)" class="text-danger small" />
                                            </div>

                                            <div class="form-group">
                                                <label>Nome / descrição do equipamento</label>
                                                <InputText class="form-control" @bind-Value="Manual.EquipmentName" />
                                                <ValidationMessage For="@(() => Manual.EquipmentName)" class="text-danger small" />
                                            </div>

                                            <div class="form-group">
                                                <label>Fábrica</label>
                                                <InputText class="form-control" @bind-Value="Manual.FactoryName" />
                                            </div>

                                            <div class="form-group">
                                                <label>Data / Revisão</label>
                                                <InputDate class="form-control"
                                                           @bind-Value="Manual.RevisionDate" />
                                            </div>
                                        </div>
                                    </div>

                                    @* I. IDENTIFICAÇÃO *@
                                    <div class="card card-outline card-info mb-2">
                                        <div class="card-header py-2">
                                            <h6 class="card-title mb-0">
                                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                                I. Identificação de energia perigosa
                                            </h6>
                                        </div>
                                        <div class="card-body py-2">
                                            <div class="form-group">
                                                <label>Nº (linha / risco)</label>
                                                <InputNumber class="form-control" @bind-Value="Manual.LineNumber" />
                                                <ValidationMessage For="@(() => Manual.LineNumber)" class="text-danger small" />
                                            </div>

                                            <div class="form-group">
                                                <label>Tipo de energia perigosa / Magnitude</label>
                                                <InputText class="form-control" @bind-Value="Manual.EnergyType" />
                                                <ValidationMessage For="@(() => Manual.EnergyType)" class="text-danger small" />
                                            </div>

                                            <div class="form-group">
                                                <label>Descrição da energia perigosa</label>
                                                <InputTextArea class="form-control" rows="4" @bind-Value="Manual.HazardDescription" />
                                                <ValidationMessage For="@(() => Manual.HazardDescription)" class="text-danger small" />
                                            </div>

                                            <div class="form-group">
                                                <label>Verificação de energia zero</label>
                                                <InputTextArea class="form-control" rows="2"
                                                               @bind-Value="Manual.ZeroEnergyVerification" />
                                            </div>

                                            <div class="form-group">
                                                <label>Teste</label>
                                                <InputTextArea class="form-control" rows="2"
                                                               @bind-Value="Manual.Test" />
                                            </div>
                                        </div>
                                    </div>

                                    @* II. CONTROLE *@
                                    <div class="card card-outline card-success mb-2">
                                        <div class="card-header py-2">
                                            <h6 class="card-title mb-0">
                                                <i class="fas fa-lock mr-1"></i>
                                                II. Controle de energias perigosas
                                            </h6>
                                        </div>
                                        <div class="card-body py-2">
                                            <div class="form-group">
                                                <label>TAG dispositivo de isolamento</label>
                                                <InputText class="form-control" @bind-Value="Manual.IsolationDeviceTag" />
                                            </div>

                                            <div class="form-group">
                                                <label>Localização dispositivo de isolamento</label>
                                                <InputText class="form-control" @bind-Value="Manual.IsolationDeviceLocation" />
                                            </div>

                                            <div class="form-group">
                                                <label>Dispositivo de isolamento</label>
                                                <InputText class="form-control" @bind-Value="Manual.IsolationDeviceDescription" />
                                            </div>

                                            <div class="form-group">
                                                <label>Bloqueio</label>
                                                <InputText class="form-control" @bind-Value="Manual.LockoutType" />
                                            </div>
                                        </div>
                                    </div>

                                    @* IMAGENS *@
                                    <div class="form-group">
                                        <label>Imagens do equipamento</label>
                                        <InputFile OnChange="ImagensManuaisSelecionadas"
                                                   accept="image/*"
                                                   multiple />
                                        @if (!string.IsNullOrEmpty(Manual.ImageFileName))
                                        {
                                            <small class="form-text text-muted">
                                                Arquivos selecionados: @Manual.ImageFileName
                                            </small>
                                        }
                                </div>

                                <div class="form-group">
                                    <label>Notas das imagens</label>
                                    <InputTextArea class="form-control" rows="4" @bind-Value="Manual.ImageNotes" />
                                </div>

                                <button type="submit"
                                        class="btn btn-success btn-block btn-sm"
                                        disabled="@(Importando || SalvandoManual)">
                                    <i class="fas fa-save mr-1"></i>
                                    @(SalvandoManual
                                                                    ? "Salvando..."
                                                                    : (IsEditMode ? "Salvar alterações" : "Salvar equipamento"))
                                    </button>
                                </EditForm>
                            }
                            else
                            {
                                @* IMPORTAÇÃO *@
                                <div class="form-group">
                                    <label>Selecione um ou mais arquivos Excel</label>
                                    <InputFile OnChange="ArquivosExcelSelecionados"
                                               multiple
                                               accept=".xlsx"
                                               disabled="@Importando" />
                                </div>

                                @if (ArquivosImportacao.Any())
                                {
                                    <div class="position-relative">
                                        <div class="table-responsive">
                                            <table class="table table-sm table-striped table-bordered mb-2">
                                                <thead class="thead-light">
                                                    <tr>
                                                        <th>Arquivo</th>
                                                        <th>Estado</th>
                                                        <th>Progresso</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var a in ArquivosImportacao)
                                                    {
                                                        <tr>
                                                            <td>@a.Nome</td>
                                                            <td>
                                                                <span class="@ClasseBadgeStatus(a.Status)">
                                                                    @a.Status
                                                                </span>
                                                                @if (!string.IsNullOrEmpty(a.MensagemErro))
                                                                {
                                                                    <br />
                                                                    <small class="text-danger">@a.MensagemErro</small>
                                                                }
                                                            </td>
                                                            <td style="width: 220px;">
                                                                <div class="progress progress-xs">
                                                                    <div class="progress-bar"
                                                                         role="progressbar"
                                                                         style="width: @a.Progresso%">
                                                                    </div>
                                                                </div>
                                                                <small>@a.Progresso %</small>
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>

                                        <button class="btn btn-primary btn-block btn-sm"
                                                disabled="@Importando"
                                                @onclick="IniciarImportacao">
                                            <i class="fas fa-file-import mr-1"></i>
                                            @(Importando ? "Importando..." : "Iniciar importação")
                                        </button>

                                        @if (!string.IsNullOrEmpty(MensagemImportacao))
                                        {
                                            <p class="mt-2 text-info">@MensagemImportacao</p>
                                        }

                                        @if (Importando)
                                        {
                                            <div class="overlay d-flex justify-content-center align-items-center">
                                                <i class="fas fa-sync-alt fa-spin fa-2x"></i>
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <p class="text-muted">Nenhum arquivo selecionado.</p>
                                }
                            }
                        }
                        else if (passoAtual == 3)
                        {
                            <p>
                                Importação/cadastro concluído.
                                A lista de equipamentos foi atualizada na linha abaixo.
                            </p>
                            <p class="text-muted mb-0">
                                Você pode continuar cadastrando manualmente ou importar novos arquivos.
                            </p>
                        }

                    </div>

                    <div class="card-footer d-flex justify-content-between">
                        @if (!IsEditMode && passoAtual < 3)
                        {
                            <button class="btn btn-secondary btn-sm"
                                    disabled="@(passoAtual == 1 || Importando)"
                                    @onclick="PassoAnterior">
                                <i class="fas fa-arrow-left mr-1"></i> Anterior
                            </button>

                            @* Esconde o "Próximo" no passo 2 quando estiver em cadastro manual *@
                            @if (!(passoAtual == 2 && ModoSelecionado == ModoCadastro.Manual))
                            {
                                <button class="btn btn-primary btn-sm"
                                        disabled="@(PlantaSelecionadaId is null or 0 || Importando)"
                                        @onclick="ProximoPasso">
                                    Próximo <i class="fas fa-arrow-right ml-1"></i>
                                </button>
                            }
                        }
                        else
                        {
                            <button class="btn btn-primary btn-sm ml-auto"
                                    disabled="@Importando"
                                    @onclick="FecharWizard">
                                Fechar
                            </button>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- LINHA 2 – LISTA (100% LARGURA) -->
        <div class="row">
            <div class="col-12">
                <div class="card card-info card-outline mb-3">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-list mr-1"></i>
                            Equipamentos
                        </h3>

                        <div class="card-tools">
                            <div class="input-group input-group-sm" style="width: 260px;">
                                <input type="text"
                                       class="form-control float-right"
                                       placeholder="Tag, nome, energia..."
                                       @bind="TermoPesquisa"
                                       @bind:event="oninput" />

                                <div class="input-group-append">
                                    <button type="button"
                                            class="btn btn-default"
                                            title="Limpar"
                                            @onclick="LimparPesquisa">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-body p-2">
                        <div class="d-flex flex-wrap justify-content-between align-items-center mb-2">
                            <div>
                                <small class="text-muted">
                                    @if (EquipamentosFiltrados?.Any() == true)
                                    {
                                        @($"{EquipamentosFiltrados.Count} equipamento(s) encontrado(s)")
                                    }
                                    else
                                    {
                                        @("Nenhum equipamento encontrado")
                                    }
                                </small>
                            </div>

                            <div class="btn-group btn-group-sm">
                                <select class="form-control form-control-sm"
                                        style="width: 80px;"
                                        @bind="TamanhoPagina">
                                    <option value="5">5</option>
                                    <option value="10">10</option>
                                    <option value="20">20</option>
                                </select>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-bordered table-hover table-sm mb-0 equip-table">
                                <thead>
                                    <tr class="thead-light">
                                        <th colspan="5" class="text-center">I. Identificação</th>
                                        <th colspan="6" class="text-center">II. Controle energias</th>
                                        <th rowspan="2" style="width: 5%;" class="text-center align-middle">Img</th>
                                        <th rowspan="2" style="width: 5%;" class="text-center align-middle">Ativo</th>
                                        <th rowspan="2" style="width: 15%;" class="text-right align-middle">Ações</th>
                                    </tr>
                                    <tr class="thead-light">
                                        <th style="width: 8%;">Tag</th>
                                        <th style="width: 22%;">Equip.</th>
                                        <th style="width: 6%;">Nº</th>
                                        <th style="width: 10%;">Tipo energ.</th>
                                        <th style="width: 18%;">Desc. energ.</th>

                                        <th style="width: 10%;">TAG disp.</th>
                                        <th style="width: 14%;">Loc. disp.</th>
                                        <th style="width: 10%;">Disp.</th>
                                        <th style="width: 8%;">Bloq.</th>
                                        <th style="width: 14%;">Verif. energ. zero</th>
                                        <th style="width: 14%;">Teste</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (EquipamentosPaginados.Any())
                                    {
                                        @foreach (var e in EquipamentosPaginados)
                                        {
                                            <tr class="@(e.IsDeleted ? "table-danger" : "")">
                                                <td>@e.Tag</td>
                                                <td>@e.EquipmentName</td>
                                                <td>@e.LineNumber</td>
                                                <td>@e.EnergyType</td>
                                                <td>@e.HazardDescription</td>

                                                <td>@e.IsolationDeviceTag</td>
                                                <td>@e.IsolationDeviceLocation</td>
                                                <td>@e.IsolationDeviceDescription</td>
                                                <td>@e.LockoutType</td>

                                                <td>@e.ZeroEnergyVerification</td>
                                                <td>@e.Test</td>

                                                <td class="text-center">
                                                    @if (!string.IsNullOrEmpty(e.ImageBlobUrl))
                                                    {
                                                        <button class="btn btn-xs btn-outline-secondary"
                                                                title="Ver imagem e notas"
                                                                @onclick="() => AbrirModalImagem(e)">
                                                            <i class="fas fa-image"></i>
                                                        </button>
                                                    }
                                                </td>
                                                <td class="text-center">
                                                    @if (!e.IsDeleted)
                                                    {
                                                        <span class="badge bg-success badge-sm">Ativo</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary badge-sm">Inativo</span>
                                                    }
                                                </td>
                                                <td class="text-right">
                                                    <button class="btn btn-xs btn-outline-primary"
                                                            title="Editar"
                                                            disabled="@Importando"
                                                            @onclick="() => IniciarEdicao(e)">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-xs btn-outline-danger"
                                                            title="Excluir"
                                                            disabled="@Importando"
                                                            @onclick="() => AbrirModalConfirmacaoExclusao(e)">
                                                        <i class="fas fa-trash-alt"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td colspan="14" class="text-center text-muted py-3">
                                                Nenhum equipamento encontrado para a planta selecionada.
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card-footer clearfix">
                        <span class="text-muted">
                            Página @PaginaAtual de @TotalPaginas
                        </span>

                        <ul class="pagination pagination-sm m-0 float-right">
                            <li class="page-item @(PaginaAtual == 1 ? "disabled" : "")">
                                <button class="page-link" @onclick="PaginaAnterior">«</button>
                            </li>
                            @for (int i = 1; i <= TotalPaginas; i++)
                            {
                                <li class="page-item @(PaginaAtual == i ? "active" : "")">
                                    <button class="page-link" @onclick="() => IrParaPagina(i)">@i</button>
                                </li>
                            }
                            <li class="page-item @(PaginaAtual == TotalPaginas ? "disabled" : "")">
                                <button class="page-link" @onclick="ProximaPagina">»</button>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        @* MODAL IMAGEM *@
        @if (MostrarModalImagem)
        {
            <div class="modal fade show"
                 tabindex="-1"
                 role="dialog"
                 style="display:block;"
                 aria-modal="true">
                <div class="modal-dialog modal-lg modal-dialog-centered modal-image" role="document">
                    <div class="modal-content">
                        <div class="modal-header bg-pw-blue text-white py-2">
                            <h5 class="modal-title mb-0">
                                <i class="fas fa-image mr-1"></i>
                                @ImagemModalTitulo
                            </h5>
                            <button type="button"
                                    class="close text-white"
                                    aria-label="Close"
                                    @onclick="FecharModalImagem">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>

                        <div class="modal-body">
                            <div class="d-flex flex-column flex-md-row align-items-start modal-image-content">
                                <div class="modal-image-wrapper text-center mb-3 mb-md-0 flex-fill">
                                    @if (!string.IsNullOrEmpty(ImagemModalUrl))
                                    {
                                        <img src="@ImagemModalUrl" class="img-fluid rounded shadow-sm" />
                                    }
                                    else
                                    {
                                        <p class="text-muted">Imagem não disponível.</p>
                                    }
                                </div>
                                <div class="modal-notes-wrapper ml-md-3">
                                    <h6 class="mb-2 text-muted">
                                        <i class="fas fa-sticky-note mr-1"></i>
                                        Notas
                                    </h6>
                                    @if (!string.IsNullOrWhiteSpace(ImagemModalNotas))
                                    {
                                        <div class="image-notes-bubble">
                                            @ImagemModalNotas
                                        </div>
                                    }
                                    else
                                    {
                                        <p class="text-muted mb-0">
                                            Nenhuma nota encontrada para esta imagem.
                                        </p>
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="modal-footer py-2">
                            <button type="button"
                                    class="btn btn-secondary btn-sm"
                                    @onclick="FecharModalImagem">
                                Fechar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-backdrop fade show"></div>
        }

        @* MODAL CONFIRMAÇÃO EXCLUSÃO *@
        @if (MostrarModalConfirmacaoExclusao && EquipamentoParaExcluir is not null)
        {
            <div class="modal fade show"
                 tabindex="-1"
                 role="dialog"
                 style="display:block;"
                 aria-modal="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content confirm-modal">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title mb-0">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                Confirmar exclusão
                            </h5>
                            <button type="button"
                                    class="close text-white"
                                    aria-label="Close"
                                    @onclick="FecharModalConfirmacaoExclusao">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>

                        <div class="modal-body">
                            <p class="mb-2">
                                Tem certeza que deseja excluir o equipamento
                                <strong>@EquipamentoParaExcluir.Tag - @EquipamentoParaExcluir.EquipmentName</strong>?
                            </p>
                        </div>

                        <div class="modal-footer d-flex justify-content-between">
                            <button type="button"
                                    class="btn btn-outline-secondary btn-sm"
                                    @onclick="FecharModalConfirmacaoExclusao">
                                <i class="fas fa-times mr-1"></i> Não
                            </button>

                            <button type="button"
                                    class="btn btn-danger btn-sm"
                                    @onclick="ConfirmarExclusaoAsync">
                                <i class="fas fa-trash-alt mr-1"></i>
                                Sim, excluir
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-backdrop fade show"></div>
        }

    </div>
</section>

<style>
    .card-title {
        font-size: 0.9rem !important;
    }

    .card-header {
        padding: 0.45rem 0.9rem !important;
    }

    .card-body {
        padding: 0.6rem 0.9rem !important;
    }

    label {
        font-size: 0.78rem !important;
        margin-bottom: 0.1rem !important;
    }

    .form-text,
    small.text-muted {
        font-size: 0.75rem !important;
    }

    .form-control {
        font-size: 0.8rem !important;
        height: calc(1.45rem + 2px);
        padding: 0.2rem 0.45rem;
    }

    .form-control-sm {
        font-size: 0.78rem !important;
        height: calc(1.35rem + 2px);
        padding: 0.18rem 0.4rem;
    }

    .form-group {
        margin-bottom: 0.4rem !important;
    }

    .btn,
    .btn-sm {
        font-size: 0.78rem !important;
        padding: 0.25rem 0.55rem !important;
    }

    .btn-xs {
        font-size: 0.72rem !important;
        padding: 0.15rem 0.4rem !important;
    }

    .equip-table th,
    .equip-table td {
        font-size: 0.78rem;
        padding: 0.25rem 0.45rem;
        vertical-align: top;
    }

    .equip-table thead th {
        font-size: 0.75rem;
        white-space: nowrap;
    }

    .pagination .page-link {
        font-size: 0.75rem;
        padding: 0.2rem 0.4rem;
    }

    .modal-image .modal-content {
        border-radius: 0.75rem;
        overflow-x: hidden;
    }

    .modal-image .modal-dialog {
        max-width: 900px;
        width: 100%;
        margin: 1.75rem auto;
    }

    .modal-image-content {
        gap: 1.5rem;
        width: 100%;
    }

    .modal-image-wrapper {
        max-width: 100%;
    }

        .modal-image-wrapper img {
            max-height: 420px;
            object-fit: contain;
        }

    .modal-notes-wrapper {
        max-width: 320px;
        width: 100%;
    }

    .image-notes-bubble {
        background-color: #fff3cd;
        border: 1px solid #f1c453;
        border-radius: 0.75rem;
        padding: 0.65rem 0.9rem;
        font-size: 0.8rem;
        line-height: 1.3rem;
        position: relative;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

        .image-notes-bubble::before {
            content: "";
            position: absolute;
            left: -10px;
            top: 18px;
            border-width: 8px 10px 8px 0;
            border-style: solid;
            border-color: transparent #f1c453 transparent transparent;
        }

    .confirm-modal {
        border-radius: 0.75rem;
    }

        .confirm-modal .modal-header {
            border-bottom: none;
            padding-bottom: 0.25rem;
        }

        .confirm-modal .modal-body {
            padding-top: 0.25rem;
            padding-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        .confirm-modal .modal-footer {
            border-top: none;
        }

    /* Ajustes responsivos para evitar overflow horizontal do modal em telas menores */
    @@media (max-width: 768px) {
        .modal-image .modal-dialog {
            max-width: 95%;
            margin: 1rem auto;
        }

        .modal-image-content {
            flex-direction: column !important;
            gap: 1rem;
        }

        .modal-notes-wrapper {
            max-width: 100%;
            width: 100%;
            margin-left: 0 !important;
            margin-top: 0.75rem;
        }
    }
</style>

@code {
    // Perfil do usuário (igual da tela de usuários)
    public enum PerfilUsuario
    {
        Usuario = 1,
        Administrador = 2,
        SuperGestor = 3
    }

    [CascadingParameter]
    private Task<AuthenticationState> AuthStateTask { get; set; } = default!;

    private PerfilUsuario PerfilLogado { get; set; } = PerfilUsuario.Usuario;
    private int? PlantaIdLogado { get; set; }

    private enum ModoCadastro
    {
        Manual,
        ImportacaoExcel
    }

    public class ManualModel
    {
        [Required(ErrorMessage = "Tag é obrigatória.")]
        public string Tag { get; set; } = string.Empty;

        [Required(ErrorMessage = "Nome / descrição do equipamento é obrigatório.")]
        public string EquipmentName { get; set; } = string.Empty;

        public string? FactoryName { get; set; }

        public string? RevisionInfo { get; set; }

        [DataType(DataType.Date)]
        public DateTime? RevisionDate { get; set; }

        [Range(1, int.MaxValue, ErrorMessage = "Nº (linha / risco) deve ser maior que zero.")]
        public int LineNumber { get; set; }

        [Required(ErrorMessage = "Tipo de energia é obrigatório.")]
        public string EnergyType { get; set; } = string.Empty;

        [Required(ErrorMessage = "Descrição da energia perigosa é obrigatória.")]
        public string HazardDescription { get; set; } = string.Empty;

        // Novos campos
        public string? ZeroEnergyVerification { get; set; }
        public string? Test { get; set; }

        public string? IsolationDeviceTag { get; set; }
        public string? IsolationDeviceLocation { get; set; }
        public string? IsolationDeviceDescription { get; set; }
        public string? LockoutType { get; set; }

        public string? ImageFileName { get; set; }
        public string? ImageNotes { get; set; }
    }

    private class ArquivoImportacaoItem
    {
        public IBrowserFile File { get; set; } = default!;
        public string Nome { get; set; } = string.Empty;
        public string Status { get; set; } = "Pendente";
        public int Progresso { get; set; }
        public string? MensagemErro { get; set; }
    }

    private int passoAtual = 1;
    private List<PlantasDto> Plantas = new();
    private int? PlantaSelecionadaId;

    private ModoCadastro ModoSelecionado = ModoCadastro.ImportacaoExcel;

    private ManualModel Manual = new();

    // Agora suportando múltiplas imagens no cadastro manual
    private List<IBrowserFile> ImagensManuais { get; set; } = new();

    private bool IsEditMode;
    private Guid? EquipamentoEmEdicaoId;

    private List<ArquivoImportacaoItem> ArquivosImportacao = new();
    private bool Importando;
    private string? MensagemImportacao;

    private bool SalvandoManual;

    private List<EquipamentoDto> Equipamentos = new();
    private bool CarregandoEquipamentos;

    private string TermoPesquisa { get; set; } = string.Empty;
    private int PaginaAtual { get; set; } = 1;
    private int TamanhoPagina { get; set; } = 10;

    private bool MostrarModalImagem;
    private string? ImagemModalUrl;
    private string? ImagemModalTitulo;
    private string? ImagemModalNotas;

    private bool MostrarModalConfirmacaoExclusao;
    private EquipamentoDto? EquipamentoParaExcluir;

    private List<EquipamentoDto> EquipamentosFiltrados =>
        string.IsNullOrWhiteSpace(TermoPesquisa)
            ? Equipamentos
            : Equipamentos
                .Where(e =>
                    (e.Tag ?? "").Contains(TermoPesquisa, StringComparison.OrdinalIgnoreCase) ||
                    (e.EquipmentName ?? "").Contains(TermoPesquisa, StringComparison.OrdinalIgnoreCase) ||
                    (e.EnergyType ?? "").Contains(TermoPesquisa, StringComparison.OrdinalIgnoreCase) ||
                    (e.HazardDescription ?? "").Contains(TermoPesquisa, StringComparison.OrdinalIgnoreCase) ||
                    (e.IsolationDeviceTag ?? "").Contains(TermoPesquisa, StringComparison.OrdinalIgnoreCase) ||
                    (e.IsolationDeviceLocation ?? "").Contains(TermoPesquisa, StringComparison.OrdinalIgnoreCase) ||
                    (e.ZeroEnergyVerification ?? "").Contains(TermoPesquisa, StringComparison.OrdinalIgnoreCase) ||
                    (e.Test ?? "").Contains(TermoPesquisa, StringComparison.OrdinalIgnoreCase))
                .ToList();

    private IEnumerable<EquipamentoDto> EquipamentosPaginados =>
        EquipamentosFiltrados
            .Skip((PaginaAtual - 1) * TamanhoPagina)
            .Take(TamanhoPagina);

    private int TotalPaginas =>
        EquipamentosFiltrados.Count == 0
            ? 1
            : (int)Math.Ceiling(EquipamentosFiltrados.Count / (double)TamanhoPagina);

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateTask;
        var user = authState.User;

        if (user.Identity?.IsAuthenticated != true)
        {
            Nav.NavigateTo("/restricted", forceLoad: true);
        }

        if (user.Identity?.IsAuthenticated == true)
        {
            if (int.TryParse(user.FindFirst("Perfil")?.Value, out var perfilInt))
                PerfilLogado = (PerfilUsuario)perfilInt;

            if (int.TryParse(user.FindFirst("PlantaId")?.Value, out var plantaId))
                PlantaIdLogado = plantaId;
        }

        await CarregarPlantasAsync();

        if (PerfilLogado == PerfilUsuario.Administrador && PlantaIdLogado.HasValue)
        {
            PlantaSelecionadaId = PlantaIdLogado.Value;
            await CarregarEquipamentosAsync();
        }
    }

    private async Task CarregarPlantasAsync()
    {
        var dtos = await PlantaService.ListarAsync();

        if (PerfilLogado == PerfilUsuario.SuperGestor)
        {
            Plantas = dtos.ToList();
        }
        else if (PlantaIdLogado.HasValue)
        {
            Plantas = dtos
                .Where(p => p.Id == PlantaIdLogado.Value)
                .ToList();
        }
        else
        {
            Plantas = dtos.ToList();
        }
    }

    private async Task ShowToastSucessoAsync(string mensagem) =>
        await Js.InvokeVoidAsync("adminlteToasts.show", "success", "Sucesso", mensagem);

    private async Task ShowToastErroAsync(string mensagem) =>
        await Js.InvokeVoidAsync("adminlteToasts.show", "error", "Erro", mensagem);

    private void PassoAnterior()
    {
        if (passoAtual > 1 && !Importando)
            passoAtual--;
    }

    private void ProximoPasso()
    {
        if (Importando)
            return;

        if (passoAtual == 1 && (PlantaSelecionadaId is null or 0))
            return;

        if (passoAtual < 3)
            passoAtual++;
    }

    private void FecharWizard()
    {
        if (Importando)
            return;

        passoAtual = 1;
        IsEditMode = false;
        EquipamentoEmEdicaoId = null;
        Manual = new ManualModel();
        ImagensManuais.Clear();
        Manual.ImageFileName = null;
        ArquivosImportacao.Clear();
        MensagemImportacao = null;
        Importando = false;
        SalvandoManual = false;
    }

    private async Task PlantaAlterada(ChangeEventArgs e)
    {
        if (Importando)
            return;

        if (int.TryParse(e.Value?.ToString(), out var id))
        {
            PlantaSelecionadaId = id;
            await CarregarEquipamentosAsync();
        }
        else
        {
            PlantaSelecionadaId = null;
            Equipamentos.Clear();
        }

        PaginaAtual = 1;
    }

    private async Task CarregarEquipamentosAsync()
    {
        if (PlantaSelecionadaId is null or 0)
            return;

        CarregandoEquipamentos = true;
        try
        {
            Equipamentos = (await EquipamentoAppService.GetByPlantAsync(PlantaSelecionadaId.Value)).ToList();
        }
        finally
        {
            CarregandoEquipamentos = false;
        }
    }

    // Múltiplas imagens no cadastro manual
    private void ImagensManuaisSelecionadas(InputFileChangeEventArgs e)
    {
        ImagensManuais.Clear();

        foreach (var file in e.GetMultipleFiles(20))
        {
            ImagensManuais.Add(file);
        }

        Manual.ImageFileName = ImagensManuais.Any()
            ? string.Join(", ", ImagensManuais.Select(f => f.Name))
            : null;
    }

    private async Task<Stream?> CriarImagemMescladaAsync()
    {
        if (!ImagensManuais.Any())
            return null;

        var imagens = new List<Image>();

        try
        {
            foreach (var file in ImagensManuais)
            {
                await using var browserStream = file.OpenReadStream(long.MaxValue);
                using var ms = new MemoryStream();
                await browserStream.CopyToAsync(ms);
                ms.Position = 0;

                imagens.Add(Image.FromStream(ms));
            }

            var largura = imagens.Max(i => i.Width);
            var alturaTotal = imagens.Sum(i => i.Height);

            var bitmapFinal = new Bitmap(largura, alturaTotal);

            using (var g = Graphics.FromImage(bitmapFinal))
            {
                g.Clear(Color.White);

                var offsetY = 0;
                foreach (var img in imagens)
                {
                    g.DrawImage(img, new Rectangle(0, offsetY, img.Width, img.Height));
                    offsetY += img.Height;
                }
            }

            var output = new MemoryStream();
            bitmapFinal.Save(output, ImageFormat.Png);
            output.Position = 0;

            return output;
        }
        finally
        {
            foreach (var img in imagens)
            {
                img.Dispose();
            }
        }
    }

    private async Task SalvarManual()
    {
        if (Importando || SalvandoManual)
            return;

        if (PlantaSelecionadaId is null or 0)
        {
            await ShowToastErroAsync("Selecione uma planta antes de salvar.");
            return;
        }

        SalvandoManual = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            Manual.RevisionInfo = Manual.RevisionDate.HasValue
                ? Manual.RevisionDate.Value.ToString("dd/MM/yyyy")
                : null;

            // Gera a imagem mesclada (se houver imagens)
            var imagemMesclada = await CriarImagemMescladaAsync();
            var hasImagem = imagemMesclada != null;

            if (IsEditMode && EquipamentoEmEdicaoId.HasValue)
            {
                var updateDto = new EquipamentoUpdateDto
                {
                    Id = EquipamentoEmEdicaoId.Value,
                    PlantId = PlantaSelecionadaId.Value,
                    Tag = Manual.Tag,
                    EquipmentName = Manual.EquipmentName,
                    FactoryName = Manual.FactoryName,
                    RevisionInfo = Manual.RevisionInfo,
                    LineNumber = Manual.LineNumber,
                    EnergyType = Manual.EnergyType,
                    HazardDescription = Manual.HazardDescription,
                    ZeroEnergyVerification = Manual.ZeroEnergyVerification,
                    Test = Manual.Test,
                    IsolationDeviceTag = Manual.IsolationDeviceTag,
                    IsolationDeviceLocation = Manual.IsolationDeviceLocation,
                    IsolationDeviceDescription = Manual.IsolationDeviceDescription,
                    LockoutType = Manual.LockoutType,
                    ImageNotes = Manual.ImageNotes
                };

                await EquipamentoAppService.UpdateAsync(updateDto);

                if (hasImagem)
                {
                    await EquipamentoAppService.UpdateImageAsync(
                        EquipamentoEmEdicaoId.Value,
                        imagemMesclada!,
                        "equipamento.png",
                        "image/png");
                }
            }
            else
            {
                var createDto = new EquipamentoCreateManualRequestDto
                {
                    PlantId = PlantaSelecionadaId.Value,
                    Tag = Manual.Tag,
                    EquipmentName = Manual.EquipmentName,
                    FactoryName = Manual.FactoryName,
                    RevisionInfo = Manual.RevisionInfo,
                    LineNumber = Manual.LineNumber,
                    EnergyType = Manual.EnergyType,
                    HazardDescription = Manual.HazardDescription,
                    ZeroEnergyVerification = Manual.ZeroEnergyVerification,
                    Test = Manual.Test,
                    IsolationDeviceTag = Manual.IsolationDeviceTag,
                    IsolationDeviceLocation = Manual.IsolationDeviceLocation,
                    IsolationDeviceDescription = Manual.IsolationDeviceDescription,
                    LockoutType = Manual.LockoutType,
                    ImageNotes = Manual.ImageNotes
                };

                await EquipamentoAppService.CreateManualAsync(
                    createDto,
                    imagemMesclada,
                    hasImagem ? "equipamento.png" : null,
                    hasImagem ? "image/png" : null);
            }

            Manual = new ManualModel();
            ImagensManuais.Clear();
            Manual.ImageFileName = null;
            IsEditMode = false;
            EquipamentoEmEdicaoId = null;

            await CarregarEquipamentosAsync();
            await ShowToastSucessoAsync("Equipamento salvo com sucesso.");
            passoAtual = 3;
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            await ShowToastErroAsync("Ocorreu um erro ao salvar o equipamento.");
        }
        finally
        {
            SalvandoManual = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void IniciarEdicao(EquipamentoDto dto)
    {
        if (Importando)
            return;

        if (PlantaSelecionadaId is null or 0)
            PlantaSelecionadaId = dto.PlantId;

        IsEditMode = true;
        EquipamentoEmEdicaoId = dto.Id;
        ModoSelecionado = ModoCadastro.Manual;
        passoAtual = 2;

        Manual = new ManualModel
        {
            Tag = dto.Tag,
            EquipmentName = dto.EquipmentName,
            FactoryName = dto.FactoryName,
            RevisionInfo = dto.RevisionInfo,
            LineNumber = dto.LineNumber,
            EnergyType = dto.EnergyType,
            HazardDescription = dto.HazardDescription,
            ZeroEnergyVerification = dto.ZeroEnergyVerification,
            Test = dto.Test,
            IsolationDeviceTag = dto.IsolationDeviceTag,
            IsolationDeviceLocation = dto.IsolationDeviceLocation,
            IsolationDeviceDescription = dto.IsolationDeviceDescription,
            LockoutType = dto.LockoutType,
            ImageNotes = dto.ImageNotes
        };

        Manual.RevisionDate = ParseNullableDate(dto.RevisionInfo);

        ImagensManuais.Clear();
        Manual.ImageFileName = null;
    }

    private DateTime? ParseNullableDate(string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
            return null;

        if (DateTime.TryParse(value, out var dt))
            return dt;

        return null;
    }

    private void ArquivosExcelSelecionados(InputFileChangeEventArgs e)
    {
        if (Importando)
            return;

        ArquivosImportacao.Clear();

        foreach (var file in e.GetMultipleFiles(50))
        {
            ArquivosImportacao.Add(new ArquivoImportacaoItem
            {
                File = file,
                Nome = file.Name,
                Status = "Pendente",
                Progresso = 0
            });
        }
    }

    private async Task IniciarImportacao()
    {
        if (Importando)
            return;

        if (!ArquivosImportacao.Any() || PlantaSelecionadaId is null or 0)
        {
            await ShowToastErroAsync("Selecione uma planta e um arquivo antes de importar.");
            return;
        }

        Importando = true;
        MensagemImportacao = "Importação iniciada...";
        await InvokeAsync(StateHasChanged);

        try
        {
            foreach (var a in ArquivosImportacao)
            {
                a.Status = "Enviado";
                a.Progresso = 10;
                await InvokeAsync(StateHasChanged);

                await using var browserStream = a.File.OpenReadStream(long.MaxValue);
                using var ms = new MemoryStream();
                await browserStream.CopyToAsync(ms);
                ms.Position = 0;

                a.Status = "Processando";
                a.Progresso = 50;
                await InvokeAsync(StateHasChanged);

                var result = await EquipamentoAppService.ImportExcelAsync(
                    PlantaSelecionadaId.Value,
                    ms,
                    a.File.Name,
                    a.File.ContentType);

                if (result.Success)
                {
                    a.Status = "Concluído";
                    a.Progresso = 100;
                }
                else
                {
                    a.Status = "Erro";
                    a.Progresso = 0;
                    a.MensagemErro = result.ErrorMessage;
                }

                await InvokeAsync(StateHasChanged);
            }

            MensagemImportacao = "Importação concluída.";
            await CarregarEquipamentosAsync();
            await ShowToastSucessoAsync("Equipamentos importados com sucesso.");
            passoAtual = 3;
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            await ShowToastErroAsync("Ocorreu um erro ao importar o(s) arquivo(s).");
            MensagemImportacao = "Erro durante a importação.";
        }
        finally
        {
            Importando = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private string ClasseBadgeStatus(string status) =>
        status switch
        {
            "Pendente" => "badge badge-secondary",
            "Enviado" => "badge badge-info",
            "Processando" => "badge badge-warning",
            "Concluído" => "badge badge-success",
            "Erro" => "badge badge-danger",
            _ => "badge badge-light"
        };

    private void AbrirModalConfirmacaoExclusao(EquipamentoDto dto)
    {
        if (Importando)
            return;

        EquipamentoParaExcluir = dto;
        MostrarModalConfirmacaoExclusao = true;
    }

    private void FecharModalConfirmacaoExclusao()
    {
        MostrarModalConfirmacaoExclusao = false;
        EquipamentoParaExcluir = null;
    }

    private async Task ConfirmarExclusaoAsync()
    {
        if (EquipamentoParaExcluir is null)
            return;

        try
        {
            await EquipamentoAppService.SoftDeleteAsync(EquipamentoParaExcluir.Id);
            await CarregarEquipamentosAsync();
            await ShowToastSucessoAsync("Equipamento marcado como inativo.");
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            await ShowToastErroAsync("Erro ao remover o equipamento.");
        }
        finally
        {
            FecharModalConfirmacaoExclusao();
        }
    }

    private void AbrirModalImagem(EquipamentoDto eq)
    {
        ImagemModalUrl = eq.ImageBlobUrl;
        ImagemModalTitulo = $"{eq.Tag} - {eq.EquipmentName}";
        ImagemModalNotas = eq.ImageNotes;
        MostrarModalImagem = true;
    }

    private void FecharModalImagem()
    {
        MostrarModalImagem = false;
        ImagemModalUrl = null;
        ImagemModalTitulo = null;
        ImagemModalNotas = null;
    }

    private void LimparPesquisa()
    {
        TermoPesquisa = string.Empty;
        PaginaAtual = 1;
    }

    private void PaginaAnterior()
    {
        if (PaginaAtual > 1)
            PaginaAtual--;
    }

    private void ProximaPagina()
    {
        if (PaginaAtual < TotalPaginas)
            PaginaAtual++;
    }

    private void IrParaPagina(int pagina)
    {
        if (pagina >= 1 && pagina <= TotalPaginas)
            PaginaAtual = pagina;
    }
}
